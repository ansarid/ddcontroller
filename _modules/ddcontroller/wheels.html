<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ddcontroller.wheels &mdash; DDController  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> DDController
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">ddcontroller</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DDController</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ddcontroller.wheels</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ddcontroller.wheels</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This file is part of the ddcontroller library (https://github.com/ansarid/ddcontroller).</span>
<span class="sd">Copyright (C) 2022  Daniyal Ansari</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">motor</span>
<span class="kn">from</span> <span class="nn">as5048b</span> <span class="kn">import</span> <span class="n">AS5048B</span>
<span class="kn">from</span> <span class="nn">simple_pid</span> <span class="kn">import</span> <span class="n">PID</span>

<div class="viewcode-block" id="Wheel"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.wheels.Wheel">[docs]</a><span class="k">class</span> <span class="nc">Wheel</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class for representing and controlling a single wheel.</span>

<span class="sd">    This class represents a single wheel, including its motor and encoder, and provides methods for controlling the speed of the motor and calculating the rotation and linear velocity of the wheel.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    closed_loop (bool): A flag indicating whether closed loop control should be used to control the motor.</span>
<span class="sd">    motor (Motor): An instance of the Motor class representing the motor driving the wheel.</span>
<span class="sd">    encoder (AS5048B): An instance of the AS5048B class representing the encoder attached to the wheel.</span>
<span class="sd">    pid (PID): An instance of the PID class representing the PID controller used for closed loop control.</span>
<span class="sd">    radius (float): The radius of the wheel, in meters.</span>
<span class="sd">    pulley_ratio (float): The ratio of the number of teeth on the motor pulley to the number of teeth on the wheel pulley.</span>
<span class="sd">    rpm (float): The rotational speed of the motor, in revolutions per minute.</span>
<span class="sd">    max_angular_velocity (float): The maximum angular velocity of the wheel, in radians per second, based on the maximum RPM of the motor.</span>
<span class="sd">    target_angular_velocity (float): The target angular velocity of the system, in radians per second, used to control the motor.</span>
<span class="sd">    position (int): The raw encoder position of the wheel, in ticks.</span>
<span class="sd">    timestamp (int): The timestamp of the last measurement of the encoder position, in nanoseconds.</span>
<span class="sd">    target_velocity (float): The target linear velocity of the wheel, in meters per second.</span>
<span class="sd">    angular_velocity (float): The current angular velocity of the wheel, in radians per second.</span>
<span class="sd">    linear_velocity (float): The current linear velocity of the wheel, in meters per second.</span>
<span class="sd">    rollover_limit (int): The limit at which the encoder position will rollover, in ticks.</span>
<span class="sd">    _positions (deque): A deque object containing the last two encoder positions of the wheel, in ticks.</span>
<span class="sd">    _timestamps (deque): A deque object containing the timestamps of the last two encoder position measurements, in nanoseconds.</span>

<span class="sd">    Args:</span>
<span class="sd">    motor_pins (tuple): A tuple containing the pins of the motor driver connected to the motor.</span>
<span class="sd">    pwm_frequency (int): The frequency of the pulse width modulation used to control the motor, in hertz.</span>
<span class="sd">    i2c_bus (int): The number of the I2C bus on which the encoder is connected.</span>
<span class="sd">    encoder_address (int): The I2C address of the encoder.</span>
<span class="sd">    wheel_radius (float): The radius of the wheel, in meters.</span>
<span class="sd">    motor_pulley_teeth (int): The number of teeth on the pulley attached to the motor shaft.</span>
<span class="sd">    wheel_pulley_teeth (int): The number of teeth on the pulley attached to the wheel hub.</span>
<span class="sd">    motor_decay_mode (str, optional): The decay mode of the motor. Can be &#39;FAST&#39; or &#39;SLOW&#39;. Defaults to &#39;FAST&#39;.</span>
<span class="sd">    invert_motor (bool, optional): A flag indicating whether the motor should be inverted. Defaults to False.</span>
<span class="sd">    invert_encoder (bool, optional): A flag indicating whether the encoder readings should be inverted. Defaults to False.</span>
<span class="sd">    closed_loop (bool, optional): A flag indicating whether closed loop control should be used to control the motor. Defaults to False.</span>
<span class="sd">    Kp (int, optional): The proportional gain of the PID controller. Defaults to 0.</span>
<span class="sd">    Ki (int, optional): The integral gain of the PID controller. Defaults to 0.</span>
<span class="sd">    Kd (int, optional): The derivative gain of the PID controller. Defaults to 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">motor_pins</span><span class="p">,</span>
        <span class="n">pwm_frequency</span><span class="p">,</span>
        <span class="n">i2c_bus</span><span class="p">,</span>
        <span class="n">encoder_address</span><span class="p">,</span>
        <span class="n">wheel_radius</span><span class="p">,</span>
        <span class="n">motor_pulley_teeth</span><span class="p">,</span>
        <span class="n">wheel_pulley_teeth</span><span class="p">,</span>
        <span class="n">motor_decay_mode</span><span class="o">=</span><span class="s1">&#39;FAST&#39;</span><span class="p">,</span>
        <span class="n">invert_motor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">invert_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">closed_loop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">Kp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Ki</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Kd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">closed_loop</span> <span class="o">=</span> <span class="n">closed_loop</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">motor</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">Motor</span><span class="p">(</span>
            <span class="n">motor_pins</span><span class="p">,</span>
            <span class="n">pwm_frequency</span><span class="p">,</span>
            <span class="n">decay_mode</span><span class="o">=</span><span class="n">motor_decay_mode</span><span class="p">,</span>
            <span class="n">invert</span><span class="o">=</span><span class="n">invert_motor</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">AS5048B</span><span class="p">(</span>
            <span class="n">encoder_address</span><span class="p">,</span>
            <span class="n">bus</span><span class="o">=</span><span class="n">i2c_bus</span><span class="p">,</span>
            <span class="n">invert</span><span class="o">=</span><span class="n">invert_encoder</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed_loop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">PID</span><span class="p">(</span><span class="n">Kp</span><span class="p">,</span> <span class="n">Ki</span><span class="p">,</span> <span class="n">Kd</span><span class="p">,</span> <span class="n">setpoint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span><span class="n">output_limits</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">max_duty</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">max_duty</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">wheel_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulley_ratio</span> <span class="o">=</span> <span class="n">motor_pulley_teeth</span> <span class="o">/</span> <span class="n">wheel_pulley_teeth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rpm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">rpm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulley_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rpm</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># create target angular velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_angular_velocity</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># stores raw encoder &#39;ticks&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">read_position</span><span class="p">()</span>

        <span class="c1"># stores age of data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_velocity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_velocity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_velocity</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># limit for rollover</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollover_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulley_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">resolution</span>

        <span class="c1"># create fifo queue object for wheel positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">read_position</span><span class="p">()],</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># create fifo queue object for wheel positions timestamps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># update values in object</span>

<div class="viewcode-block" id="Wheel.update"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.wheels.Wheel.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the encoder position and timestamp.</span>

<span class="sd">        This method updates the position and timestamp of the encoder by reading the current position and adding it to a queue of positions and timestamps. The most recent position and timestamp are then stored as attributes of the Wheel object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Append new position to_positions queue.</span>
        <span class="c1"># This will push out the oldest item in the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">read_position</span><span class="p">())</span>
        <span class="c1"># Append new timestamp to _timestamps queue.</span>
        <span class="c1"># This will push out the oldest item in the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># set latest position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># set timestamp of latest data</span></div>

<div class="viewcode-block" id="Wheel.get_rotation"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.wheels.Wheel.get_rotation">[docs]</a>    <span class="k">def</span> <span class="nf">get_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the rotation of the wheel.</span>

<span class="sd">        This method calculates and returns the rotation of the wheel, in ticks, based on the positions of the encoder at two different points in time. It also accounts for rollover, where the encoder position resets after reaching a certain value. The rotation is calculated by taking the difference between the encoder positions and applying a pulley ratio to convert from motor pulley rotation to wheel rotation.</span>

<span class="sd">        Returns:</span>
<span class="sd">        int: The rotation of the wheel, in ticks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># calculate how much wheel has rotated</span>
        <span class="c1"># if the movement has rollover</span>
        <span class="k">if</span> <span class="o">-</span><span class="n">rotation</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollover_limit</span><span class="p">:</span>
            <span class="c1"># handle forward rollover</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">resolution</span>
        <span class="c1"># if movement has rollover in the negative direction</span>
        <span class="k">if</span> <span class="n">rotation</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollover_limit</span><span class="p">:</span>
            <span class="c1"># handle reverse rollover</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">resolution</span>
        <span class="c1"># go from motor pulley to wheel pulley</span>
        <span class="n">rotation</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulley_ratio</span>
        <span class="c1"># return wheel advancement in ticks</span>
        <span class="k">return</span> <span class="n">rotation</span></div>

<div class="viewcode-block" id="Wheel.get_travel"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.wheels.Wheel.get_travel">[docs]</a>    <span class="k">def</span> <span class="nf">get_travel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># calculate travel of the wheel in meters</span>
        <span class="sd">&quot;&quot;&quot;Get the distance traveled by the wheel.</span>

<span class="sd">        This method calculates and returns the distance traveled by the wheel, in meters, based on the rotation of the wheel and the radius of the wheel.</span>

<span class="sd">        Returns:</span>
<span class="sd">        float: The distance traveled by the wheel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get wheel rotation between measurements</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rotation</span><span class="p">()</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">rotation</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">resolution</span>
        <span class="p">)</span>  <span class="c1"># calculate distance traveled in wheel rotation</span>
        <span class="k">return</span> <span class="n">distance</span>  <span class="c1"># return distance traveled in meters</span></div>

<div class="viewcode-block" id="Wheel.get_linear_velocity"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.wheels.Wheel.get_linear_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_linear_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># get wheel linear velocity</span>
        <span class="sd">&quot;&quot;&quot;Get the current linear velocity of the wheel.</span>

<span class="sd">        This method calculates and returns the current linear velocity of the wheel, in meters per second, based on the distance traveled by the wheel and the elapsed time between measurements.</span>

<span class="sd">        Returns:</span>
<span class="sd">        float: The current linear velocity of the wheel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_travel</span><span class="p">()</span>  <span class="c1"># get wheel travel</span>
        <span class="c1"># calculate delta_time, convert from ns to s</span>
        <span class="n">delta_time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="c1"># calculate wheel linear velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_velocity</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">delta_time</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_velocity</span></div>

<div class="viewcode-block" id="Wheel.get_angular_velocity"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.wheels.Wheel.get_angular_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_angular_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current angular velocity of the wheel.</span>

<span class="sd">        This method calculates and returns the current angular velocity of the wheel, in radians per second, based on the rotation of the wheel and the elapsed time between measurements.</span>

<span class="sd">        Returns:</span>
<span class="sd">        float: The current angular velocity of the wheel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get wheel rotation between measurements</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rotation</span><span class="p">()</span>
        <span class="c1"># calculate delta_time, convert from ns to s</span>
        <span class="n">delta_time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="c1"># speed produced from true wheel rotation (rad)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_velocity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rotation</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">resolution</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">delta_time</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_velocity</span></div>

<div class="viewcode-block" id="Wheel.set_angular_velocity"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.wheels.Wheel.set_angular_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">set_angular_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angular_velocity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the target angular velocity of the wheel.</span>

<span class="sd">        This method sets the target angular velocity of the wheel, which is used to control the speed of the motor. The motor&#39;s duty cycle is adjusted based on the target angular velocity, using either open loop or closed loop control.</span>

<span class="sd">        Args:</span>
<span class="sd">        angular_velocity (float): The target angular velocity to set, in radians per second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_angular_velocity</span> <span class="o">=</span> <span class="n">angular_velocity</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed_loop</span><span class="p">:</span>
            <span class="c1"># Open loop control</span>
            <span class="n">duty</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">max_duty</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">target_angular_velocity</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed_loop</span><span class="p">:</span>
            <span class="c1"># Closed loop PID control</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_angular_velocity</span>
            <span class="n">duty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_angular_velocity</span><span class="p">())</span>

        <span class="c1"># set duty cycle to motor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">set_duty</span><span class="p">(</span><span class="n">duty</span><span class="p">)</span></div>

<div class="viewcode-block" id="Wheel.stop"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.wheels.Wheel.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the motor driving the wheel.</span>

<span class="sd">        This method stops the motor driving the wheel by setting the duty cycle to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Daniyal Ansari.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>