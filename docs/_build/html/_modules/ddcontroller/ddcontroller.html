<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ddcontroller.ddcontroller &mdash; DDController  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> DDController
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">ddcontroller</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DDController</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ddcontroller.ddcontroller</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ddcontroller.ddcontroller</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This file is part of the ddcontroller library (https://github.com/ansarid/ddcontroller).</span>
<span class="sd">Copyright (C) 2022  Daniyal Ansari</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">simple_pid</span> <span class="kn">import</span> <span class="n">PID</span>
<span class="kn">from</span> <span class="nn">ruamel.yaml</span> <span class="kn">import</span> <span class="n">YAML</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">wheels</span>

<span class="n">yaml</span> <span class="o">=</span> <span class="n">YAML</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;safe&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="DDRobot"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot">[docs]</a><span class="k">class</span> <span class="nc">DDRobot</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s1">&#39;/opt/ddcontroller/config/default.yaml&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Initialize a DDRobot object.</span>

<span class="sd">        This method initializes a DDRobot object by setting up the wheels and loading the configuration from a YAML file. The robot has various attributes such as its heading, linear velocity, and global position, as well as target motion, heading, and position. The robot also has various constants such as its wheel base, maximum linear and angular velocities, and tolerance for reaching the target position.</span>

<span class="sd">        Args:</span>
<span class="sd">        config_path (str, optional): The path to the YAML configuration file. Defaults to &#39;/opt/ddcontroller/config/default.yaml&#39;.</span>
<span class="sd">        debug (bool, optional): Whether to print debugging messages. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded config from: </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">Labeled: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_velocity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_velocity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_heading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_tolerance</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reached_target_position</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backwards</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">odometry_frequency</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading_controller_frequency</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_controller_frequency</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">control_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wheel_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;wheel_base&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_linear_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;max_linear_velocity&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;max_angular_velocity&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_traveling_linear_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;max_traveling_linear_velocity&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_traveling_angular_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;max_traveling_angular_velocity&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span> <span class="o">=</span> <span class="n">wheels</span><span class="o">.</span><span class="n">Wheel</span><span class="p">(</span>
            <span class="n">motor_pins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor&#39;</span><span class="p">][</span><span class="s1">&#39;pins&#39;</span><span class="p">],</span>
            <span class="n">pwm_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor&#39;</span><span class="p">][</span><span class="s1">&#39;pwm_frequency&#39;</span><span class="p">],</span>
            <span class="n">motor_decay_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor&#39;</span><span class="p">][</span><span class="s1">&#39;decay_mode&#39;</span><span class="p">],</span>
            <span class="n">i2c_bus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;encoder&#39;</span><span class="p">][</span><span class="s1">&#39;i2c_bus&#39;</span><span class="p">],</span>
            <span class="n">encoder_address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;encoder&#39;</span><span class="p">][</span><span class="s1">&#39;address&#39;</span><span class="p">],</span>
            <span class="n">wheel_radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;wheel_radius&#39;</span><span class="p">],</span>
            <span class="n">motor_pulley_teeth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor_pulley_teeth&#39;</span><span class="p">],</span>
            <span class="n">wheel_pulley_teeth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;wheel_pulley_teeth&#39;</span><span class="p">],</span>
            <span class="n">invert_motor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor&#39;</span><span class="p">][</span><span class="s1">&#39;invert&#39;</span><span class="p">],</span>
            <span class="n">invert_encoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;encoder&#39;</span><span class="p">][</span><span class="s1">&#39;invert&#39;</span><span class="p">],</span>
            <span class="n">closed_loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;closed_loop&#39;</span><span class="p">],</span>
            <span class="n">Kp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;Kp&#39;</span><span class="p">],</span>
            <span class="n">Ki</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;Ki&#39;</span><span class="p">],</span>
            <span class="n">Kd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;left_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;Kd&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span> <span class="o">=</span> <span class="n">wheels</span><span class="o">.</span><span class="n">Wheel</span><span class="p">(</span>
            <span class="n">motor_pins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor&#39;</span><span class="p">][</span><span class="s1">&#39;pins&#39;</span><span class="p">],</span>
            <span class="n">pwm_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor&#39;</span><span class="p">][</span><span class="s1">&#39;pwm_frequency&#39;</span><span class="p">],</span>
            <span class="n">motor_decay_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor&#39;</span><span class="p">][</span><span class="s1">&#39;decay_mode&#39;</span><span class="p">],</span>
            <span class="n">i2c_bus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;encoder&#39;</span><span class="p">][</span><span class="s1">&#39;i2c_bus&#39;</span><span class="p">],</span>
            <span class="n">encoder_address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;encoder&#39;</span><span class="p">][</span><span class="s1">&#39;address&#39;</span><span class="p">],</span>
            <span class="n">wheel_radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;wheel_radius&#39;</span><span class="p">],</span>
            <span class="n">motor_pulley_teeth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor_pulley_teeth&#39;</span><span class="p">],</span>
            <span class="n">wheel_pulley_teeth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;wheel_pulley_teeth&#39;</span><span class="p">],</span>
            <span class="n">invert_motor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;motor&#39;</span><span class="p">][</span><span class="s1">&#39;invert&#39;</span><span class="p">],</span>
            <span class="n">invert_encoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;encoder&#39;</span><span class="p">][</span><span class="s1">&#39;invert&#39;</span><span class="p">],</span>
            <span class="n">closed_loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;closed_loop&#39;</span><span class="p">],</span>
            <span class="n">Kp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;Kp&#39;</span><span class="p">],</span>
            <span class="n">Ki</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;Ki&#39;</span><span class="p">],</span>
            <span class="n">Kd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;right_wheel&#39;</span><span class="p">][</span><span class="s1">&#39;Kd&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heading_pid</span> <span class="o">=</span> <span class="n">PID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;heading_Kp&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;heading_Ki&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;heading_Kd&#39;</span><span class="p">],</span>
                               <span class="n">setpoint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heading_pid</span><span class="o">.</span><span class="n">output_limits</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loop_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">][</span><span class="s1">&#39;wheel_frequency&#39;</span><span class="p">]</span>  <span class="c1"># target wheel loop frequency (hz)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_freq</span>
        <span class="p">)</span>  <span class="c1"># corrected wait time between encoder measurements (s)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">odometry_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_odometry_loop</span>
        <span class="p">)</span>  <span class="c1"># create odometry thread object</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heading_controller_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_heading_controller</span>
        <span class="p">)</span>  <span class="c1"># create heading controller thread object</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">position_controller_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_position_controller</span>
        <span class="p">)</span>  <span class="c1"># create position controller thread object</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">odometry_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>                <span class="c1"># start odometry thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading_controller_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>      <span class="c1"># start heading controller thread # Ideally we don&#39;t start this until it&#39;s needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_controller_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>     <span class="c1"># start position contoller thread # Ideally we don&#39;t start this until it&#39;s needed</span>

<div class="viewcode-block" id="DDRobot.sleep"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.sleep">[docs]</a>    <span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">        Args:</span>
<span class="sd">            start_time (_type_): _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># measure time since start and subtract from sleep time</span>
        <span class="n">sleep_time</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">-</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sleep_time</span></div>

    <span class="k">def</span> <span class="nf">_odometry_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span>  <span class="c1"># record loop start time</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># update left wheel readings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># update right wheel readings</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">linear_velocity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_velocity</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_motion</span><span class="p">()</span>  <span class="c1"># get robot linear and angular velocities</span>

            <span class="n">left_wheel_travel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">get_travel</span><span class="p">()</span>
            <span class="n">right_wheel_travel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">get_travel</span><span class="p">()</span>

            <span class="n">wheelbase_travel</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">left_wheel_travel</span> <span class="o">+</span> <span class="n">right_wheel_travel</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># calculate wheelbase displacement</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">global_position</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">wheelbase_travel</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">)</span>
                <span class="p">),</span>  <span class="c1"># calculate global x position</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">wheelbase_travel</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">)</span>
                <span class="p">),</span>  <span class="c1"># calculate global y position</span>
            <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">+</span> <span class="p">((</span><span class="n">right_wheel_travel</span> <span class="o">-</span> <span class="n">left_wheel_travel</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">wheel_base</span><span class="p">)),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">+</span> <span class="p">((</span><span class="n">right_wheel_travel</span> <span class="o">-</span> <span class="n">left_wheel_travel</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">wheel_base</span><span class="p">))</span>
                                    <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">odometry_frequency</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">/</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_heading_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span>  <span class="c1"># record loop start time</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>

                <span class="n">heading_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_heading</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_heading</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backwards</span><span class="p">:</span>
                    <span class="n">heading_error</span><span class="o">+=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">heading_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">heading_error</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">heading_error</span><span class="p">))</span>
                <span class="n">angular_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading_pid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading_error</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_angular_velocity</span><span class="p">(</span><span class="n">angular_velocity</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heading_controller_frequency</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">/</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_position_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">position_error</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_position</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">global_position</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_error</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span>  <span class="c1"># record loop start time</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">reached_target_position</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">while</span> <span class="n">position_error</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tolerance</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span>  <span class="c1"># record loop start time</span>

                    <span class="n">target_heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">target_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">global_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]),(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">global_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_heading</span><span class="p">(</span><span class="n">target_heading</span><span class="p">,</span> <span class="n">max_angular_velocity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backwards</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_traveling_linear_velocity</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_linear_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_traveling_linear_velocity</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_linear_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_linear_velocity</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_traveling_linear_velocity</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_linear_velocity</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_traveling_linear_velocity</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="p">))))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_linear_velocity</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_linear_velocity</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="p">))))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">position_controller_frequency</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">/</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">reached_target_position</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position_controller_frequency</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">/</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic_ns</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>

<div class="viewcode-block" id="DDRobot.stop"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Stop the robot.</span>

<span class="sd">        This method stops the robot by setting the motion to 0, stopping the control threads, and stopping the wheels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_motion</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">odometry_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading_controller_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_controller_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="DDRobot.define_heading"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.define_heading">[docs]</a>    <span class="k">def</span> <span class="nf">define_heading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heading</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define the heading of the robot.</span>

<span class="sd">        This method defines the heading of the robot by taking the arctangent of the sine and cosine of the input heading, constraining the heading to be between -pi and pi. The defined heading is then stored as an attribute of the DDRobot object and returned.</span>

<span class="sd">        Args:</span>
<span class="sd">        heading (float): The heading of the robot in radians.</span>

<span class="sd">        Returns:</span>
<span class="sd">        float: The defined heading of the robot in radians, constrained to be between -pi and pi.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">heading</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">heading</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span></div>

<div class="viewcode-block" id="DDRobot.set_heading"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.set_heading">[docs]</a>    <span class="k">def</span> <span class="nf">set_heading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_heading</span><span class="p">,</span> <span class="n">max_angular_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the heading of the robot.</span>

<span class="sd">        This method sets the target heading of the robot by taking the arctangent of the sine and cosine of the input heading, constraining the heading to be between -pi and pi. The maximum angular velocity of the robot can also be set as an optional parameter. The control level of the robot is set to 2, indicating that heading control is active.</span>

<span class="sd">        Args:</span>
<span class="sd">        target_heading (float): The target heading of the robot in radians.</span>
<span class="sd">        max_angular_velocity (float, optional): The maximum angular velocity of the robot in radians per second. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">max_angular_velocity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heading_pid</span><span class="o">.</span><span class="n">output_limits</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">max_angular_velocity</span><span class="p">,</span> <span class="n">max_angular_velocity</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">control_level</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">target_heading</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">target_heading</span><span class="p">))</span></div>

<div class="viewcode-block" id="DDRobot.get_heading"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.get_heading">[docs]</a>    <span class="k">def</span> <span class="nf">get_heading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the heading of the robot.</span>

<span class="sd">        This method returns the heading of the robot as an attribute of the DDRobot object.</span>

<span class="sd">        Returns:</span>
<span class="sd">        float: The heading of the robot in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span></div>

<div class="viewcode-block" id="DDRobot.define_global_position"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.define_global_position">[docs]</a>    <span class="k">def</span> <span class="nf">define_global_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define the global position of the robot.</span>

<span class="sd">        This method sets the global position of the robot as an attribute of the DDRobot object.</span>

<span class="sd">        Args:</span>
<span class="sd">        position (list): A list containing the x and y position of the robot.</span>

<span class="sd">        Returns:</span>
<span class="sd">        list: The global position of the robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_position</span> <span class="o">=</span> <span class="n">position</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_position</span></div>

<div class="viewcode-block" id="DDRobot.get_global_position"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.get_global_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_global_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the global position of the robot.</span>

<span class="sd">        This method returns the global position of the robot as an attribute of the DDRobot object.</span>

<span class="sd">        Returns:</span>
<span class="sd">        list: The global position of the robot, as a list containing the x and y position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_position</span></div>

<div class="viewcode-block" id="DDRobot.get_linear_velocity"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.get_linear_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_linear_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the linear velocity of the robot.</span>

<span class="sd">        This method returns the linear velocity of the robot as an attribute of the DDRobot object.</span>

<span class="sd">        Returns:</span>
<span class="sd">        float: The linear velocity of the robot, in meters per second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_velocity</span></div>

<div class="viewcode-block" id="DDRobot.get_angular_velocity"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.get_angular_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_angular_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the angular velocity of the robot.</span>

<span class="sd">        This method returns the angular velocity of the robot as an attribute of the DDRobot object.</span>

<span class="sd">        Returns:</span>
<span class="sd">        float: The angular velocity of the robot, in radians per second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_velocity</span></div>

<div class="viewcode-block" id="DDRobot.set_linear_velocity"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.set_linear_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">set_linear_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_velocity</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set the desired linear velocity of the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            linear_velocity (float): The linear velocity to set in meters per second.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The updated target motion of the robot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_motion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span></div>

<div class="viewcode-block" id="DDRobot.set_angular_velocity"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.set_angular_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">set_angular_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angular_velocity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the target angular velocity for the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            angular_velocity (float): The desired angular velocity of the robot in radians per second.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The current target motion of the robot, where the first element is the linear velocity and the second element is the angular velocity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">angular_velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_motion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span></div>

<div class="viewcode-block" id="DDRobot.set_motion"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.set_motion">[docs]</a>    <span class="k">def</span> <span class="nf">set_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_motion</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the target linear and angular velocities for the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_motion (list): A list containing the target linear velocity (m/s) as the first element</span>
<span class="sd">                                 and the target angular velocity (rad/s) as the second element.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: An array containing the target angular velocities (rad/s) for the left and right wheels.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_motion</span> <span class="o">=</span> <span class="n">target_motion</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                      <span class="p">[</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wheel_base</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">radius</span><span class="p">],</span>
                      <span class="p">[</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wheel_base</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">radius</span><span class="p">]</span>
                    <span class="p">])</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_motion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">target_motion</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">max_angular_velocity</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Left wheel requested angular velocity exceeded maximum(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">max_angular_velocity</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Right wheel requested angular velocity exceeded maximum(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">set_angular_velocity</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">set_angular_velocity</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">C</span></div>

<div class="viewcode-block" id="DDRobot.get_motion"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.get_motion">[docs]</a>    <span class="k">def</span> <span class="nf">get_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate and return the current linear and angular velocities of the robot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of two floats, representing the linear and angular velocities of the robot, in that order.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">radius</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">wheel_base</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">radius</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">wheel_base</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">left_wheel</span><span class="o">.</span><span class="n">get_angular_velocity</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right_wheel</span><span class="o">.</span><span class="n">get_angular_velocity</span><span class="p">(),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">linear_velocity</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_velocity</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_velocity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_velocity</span><span class="p">]</span></div>

<div class="viewcode-block" id="DDRobot.go_to"><a class="viewcode-back" href="../../ddcontroller.html#ddcontroller.ddcontroller.DDRobot.go_to">[docs]</a>    <span class="k">def</span> <span class="nf">go_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_position</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_linear_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_angular_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backwards</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves the robot to the specified target position using a position controller.</span>
<span class="sd">        The robot will continue to move towards the target position until it is within the specified tolerance.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_position (list): The target position as a 2-element list [x, y] in global coordinates.</span>
<span class="sd">            tolerance (float, optional): The tolerance for reaching the target position in meters. Defaults to 0.1.</span>
<span class="sd">            max_linear_velocity (float, optional): The maximum linear velocity the robot will use to reach the target position in m/s. If not provided, the default value specified in the configuration file will be used.</span>
<span class="sd">            max_angular_velocity (float, optional): The maximum angular velocity the robot will use to reach the target position in rad/s. If not provided, the default value specified in the configuration file will be used.</span>
<span class="sd">            backwards (bool, optional): Whether the robot should move backwards to reach the target position. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_position</span> <span class="o">=</span> <span class="n">target_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backwards</span><span class="o">=</span><span class="n">backwards</span>

        <span class="k">if</span> <span class="n">max_linear_velocity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_linear_velocity</span> <span class="o">=</span> <span class="n">max_linear_velocity</span>
        <span class="k">if</span> <span class="n">max_angular_velocity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_angular_velocity</span> <span class="o">=</span> <span class="n">max_angular_velocity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reached_target_position</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_level</span> <span class="o">=</span> <span class="mi">2</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Daniyal Ansari.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>